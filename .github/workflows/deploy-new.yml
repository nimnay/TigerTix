name: CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      # Frontend
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: Run frontend tests
        run: |
          cd frontend
          npm test -- --watchAll=false --passWithNoTests

      - name: Build frontend
        run: |
          cd frontend
          npm run build

      # Backend Services
      - name: Install user-authentication dependencies
        run: |
          cd backend/user-authentication
          npm ci

      - name: Test user-authentication
        env:
          JWT_SECRET: test-secret-key
        run: |
          cd backend/user-authentication
          npm test -- --passWithNoTests

      - name: Install admin-service dependencies
        run: |
          cd backend/admin-service
          npm ci

      - name: Test admin-service
        run: |
          cd backend/admin-service
          npm test -- --passWithNoTests

      - name: Install client-service dependencies
        run: |
          cd backend/client-service
          npm ci

      - name: Test client-service
        run: |
          cd backend/client-service
          npm test -- --passWithNoTests

      - name: Install llm-service dependencies
        run: |
          cd backend/llm-service
          npm ci

      - name: Test llm-service
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cd backend/llm-service
          npm test -- --passWithNoTests

      - name: All tests passed
        run: |
          echo "âœ… All tests passed!"
          echo "ðŸš€ Deployment will happen automatically via Render/Vercel GitHub integration"
